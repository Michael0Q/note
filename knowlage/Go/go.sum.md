# go.sum：依存関係の正しさを保証する「封印」

## 1. `go.sum`とは？

`go.sum`ファイルは、プロジェクトが依存する各モジュールのバージョンとその内容（ソースコード）が期待通りであることを保証するための**チェックサムデータベース**です。

`go.mod`が「どのモジュールのどのバージョンを使うか」という**レシピ**を定義するのに対し、`go.sum`は、そのレシピで取得した**食材（モジュールのコード）**が、最初に使ったときから改ざんされていないことを証明する「封印」の役割を果たします。

Go はモジュールをダウンロードする際、その内容からハッシュ値を計算し、`go.sum`に記録されているハッシュ値と一致するかを検証します。もし一致しなければ、ビルドはエラーとなり、潜在的なセキュリティリスク（サプライチェーン攻撃など）から開発者を守ります。

## 2. なぜ`go.sum`が必要なのか？

- **セキュリティ**: 依存モジュールのソースリポジトリ（例: GitHub）が書き換えられたり、プロキシサーバーが不正なコードを配信したりしても、`go.sum`のチェックサムと一致しないため、意図しないコードの実行を未然に防ぎます。
- **ビルドの完全性**: チームの誰もが、まったく同じ内容の依存関係コードを使ってビルドしていることを保証します。`go.mod`だけではバージョンは指定できますが、そのバージョンの「内容」までは保証できません。`go.sum`がその役割を担います。
- **ロックファイルではない**: `go.sum`は`yarn.lock`や`package-lock.json`のようなロックファイルではありません。`go.mod`だけでビルドの再現性は担保されています。`go.sum`はあくまでセキュリティのための追加的な検証レイヤーです。

## 3. `go.sum`のフォーマット

`go.sum`ファイルには、通常 1 つのモジュールバージョンに対して 2 つのエントリが記録されます。

```
<module> <version> <hash>
<module> <version>/go.mod <hash>
```

例えば、`golang.org/x/text`の`v0.3.7`に依存している場合、`go.sum`には以下のように記録されます。

```
golang.org/x/text v0.3.7 h1:yGOw9/d9u4bCRfragGtc1P6iFzB5BC2t2yq3l91N5dQ=
golang.org/x/text v0.3.7/go.mod h1:NqM86UagrSRmVDXA/aMXEE2V2NA+DuUvQ/E3B4Ue3pU=
```

1.  **一行目 (`<module> <version> <hash>`)**:
    - モジュール全体のソースコード（`.zip`ファイル）のハッシュです。
    - これにより、モジュールに含まれるすべてのファイルが改ざんされていないことを保証します。
2.  **二行目 (`<module> <version>/go.mod <hash>`)**:
    - そのモジュールの`go.mod`ファイル単体のハッシュです。
    - Go は依存関係を解決する際に、依存先の`go.mod`ファイルも解析します。そのため、`go.mod`ファイル自体の正当性も個別に検証する必要があります。

`h1:`というプレフィックスは、ハッシュアルゴリズムが SHA-256 であることを示しています。

## 4. `go mod tidy`との関係

`go mod tidy`コマンドを実行すると、`go.mod`ファイルがプロジェクトのソースコードと一致するように更新されるだけでなく、`go.sum`ファイルも同時に更新されます。

- `go.mod`に追加された新しい依存関係があれば、そのモジュールをダウンロードし、チェックサムを`go.sum`に追記します。
- `go.mod`から削除された不要な依存関係があれば、関連するチェックサムを`go.sum`から削除します。

## 5. `go.sum`はバージョン管理に含めるべきか？

**はい、必ず含めるべきです。**

`go.mod`ファイルと一緒に`go.sum`ファイルを Git などのバージョン管理システムにコミットすることで、以下のメリットがあります。

- **チームでの一貫性**: 他のチームメンバーや CI/CD 環境がプロジェクトをビルドする際に、あなたと同じチェックサムを使って依存関係を検証できます。
- **セキュリティの担保**: プロジェクトの依存関係の正当性が、リポジトリの履歴として追跡・保証されます。

## 6. まとめ

- `go.sum`は、依存モジュールの内容が改ざんされていないことを保証するチェックサムファイルです。
- `go.mod`が「何を」使うかを定義し、`go.sum`が「その内容が正しいか」を検証します。
- `go.mod`と同様に、バージョン管理に含めることが強く推奨されます。
- `go mod tidy`によって、`go.mod`と同期した状態に保たれます。
