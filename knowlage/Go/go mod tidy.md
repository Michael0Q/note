# go mod tidy：Go モジュールの依存関係を整理する「執事」

## 1. `go mod tidy`とは？

`go mod tidy`は、プロジェクトのソースコードと`go.mod`ファイルの整合性を保つためのコマンドです。具体的には、以下の 2 つの主要な役割を担います。

1.  **依存関係の追加**: ソースコード内で`import`されているが、`go.mod`に記載されていないモジュール（依存関係）を**自動で追加**します。
2.  **依存関係の削除**: `go.mod`には記載されているが、ソースコードのどこからも`import`されていない不要なモジュールを**自動で削除**します。

まさに、プロジェクトの依存関係を常にクリーンな状態に保ってくれる「執事」のような存在です。

## 2. なぜ`go mod tidy`が必要なのか？

手動で`go get`コマンドを使って依存関係を管理することも可能ですが、`go mod tidy`には以下のようなメリットがあります。

- **正確性**: プロジェクト全体のソースコード（テストコードも含む）を静的に解析し、実際に必要とされている依存関係だけを`go.mod`に残します。手動での管理ミスを防ぎます。
- **効率性**: 新しいパッケージを追加した際に、`go get`を個別に実行する必要がありません。ソースコードに`import`文を追記して`go mod tidy`を実行するだけで、必要なものがすべて`go.mod`に反映されます。
- **クリーンな状態の維持**: 開発の過程で不要になった依存関係が`go.mod`に残り続けることを防ぎ、モジュールを常に最小限のクリーンな状態に保ちます。

## 3. `go mod tidy`の動作

`go mod tidy`を実行すると、Go は以下のステップで動作します。

1.  **ビルドリストの作成**: メインモジュール内のすべてのパッケージと、それらがインポートするすべてのパッケージを再帰的にスキャンします。これには、テストコード（`_test.go`ファイル）の依存関係も含まれます。
2.  **`go.mod`との比較**:
    - ビルドリストにあるが`go.mod`にないモジュールがあれば、最新バージョンを`require`に追加します。
    - `go.mod`にあるがビルドリストにないモジュールがあれば、その`require`行を削除します。
3.  **`go.sum`の更新**:
    - `go.mod`の変更に伴い、必要になったモジュールのチェックサムを`go.sum`に追加します。
    - 不要になったモジュールのチェックサムを`go.sum`から削除します。

### ワークフローの例

1.  **コーディング**: 新機能実装のために、`main.go`に`"github.com/google/uuid"`を`import`する。

    ```go
    package main

    import (
    	"fmt"
    	"github.com/google/uuid"
    )

    func main() {
    	id := uuid.New()
    	fmt.Println(id)
    }
    ```

2.  **`tidy`の実行**: この時点では`go.mod`に`uuid`は存在しない。ターミナルで`go mod tidy`を実行する。

    ```sh
    $ go mod tidy
    go: finding module for package github.com/google/uuid
    go: found github.com/google/uuid in github.com/google/uuid v1.6.0
    ```

3.  **結果の確認**: `go.mod`ファイルを見ると、`require`ディレクティブが自動で追加されている。

    ```go
    // go.mod
    module example.com/myproject

    go 1.22.0

    require github.com/google/uuid v1.6.0 // indirect
    ```

4.  **リファクタリング**: 後日、`uuid`を使わなくなったため、`main.go`から`import`文を削除する。
5.  **再度`tidy`を実行**: `go mod tidy`を再度実行すると、不要になった`uuid`の`require`行が`go.mod`から自動的に削除される。

## 4. `go get`との違い

- `go get`: **特定のモジュール**を`go.mod`に追加、更新、または削除するためのコマンド。開発者が「このパッケージを使いたい」と明示的に指示します。
- `go mod tidy`: **プロジェクト全体**をスキャンし、`go.mod`をソースコードの現状と一致させるためのコマンド。「現状に合わせておいて」という包括的な整理を依頼します。

新しい依存関係を追加する際は、`import`文を書いてから`go mod tidy`を実行するフローが、現代的な Go 開発では一般的です。

## 5. まとめ

- `go mod tidy`は、`go.mod`とソースコードの依存関係を同期させるための必須コマンドです。
- 必要なモジュールを自動で追加し、不要なモジュールを自動で削除します。
- これにより、`go.mod`ファイルは常に最小限でクリーンな状態に保たれ、プロジェクトの依存関係管理が大幅に簡素化されます。
- `go get`が特定のパッケージに対する操作であるのに対し、`go mod tidy`はプロジェクト全体に対する網羅的な整理操作です。

関連
[[go.sum]]