# Base64

## 概要

Base64 は、バイナリデータを 64 種類の英数字のみを使用して表現するエンコーディング方式です。電子メールや MIME (Multipurpose Internet Mail Extensions)、XML、その他、テキストデータしか扱うことのできない環境でバイナリデータを安全に転送・保存するために使用されます。

このナレッジは主に **RFC 4648** を元に作成されています。

## エンコーディングプロセス

Base64 エンコーディングは、元のバイナリデータを 24 ビット（3 バイト）ずつに分割し、その 24 ビットを 6 ビットずつ 4 つのグループに分けます。それぞれの 6 ビットのグループは 0 から 63 までの数値を表現し、その数値を Base64 アルファベットの特定の文字に対応付けます。

- 3 バイト (24 ビット) の入力 -> 4 文字の出力
- データ長が 3 の倍数でない場合、末尾にパディング文字 `=` が付与されます。

## アルファベット

標準の Base64 で使用される 64 文字のアルファベットは以下の通りです。

| 値  | 文字 | 値  | 文字 | 値  | 文字 | 値  | 文字 |
| --- | ---- | --- | ---- | --- | ---- | --- | ---- |
| 0   | A    | 16  | Q    | 32  | g    | 48  | w    |
| 1   | B    | 17  | R    | 33  | h    | 49  | x    |
| 2   | C    | 18  | S    | 34  | i    | 50  | y    |
| 3   | D    | 19  | T    | 35  | j    | 51  | z    |
| 4   | E    | 20  | U    | 36  | k    | 52  | 0    |
| 5   | F    | 21  | V    | 37  | l    | 53  | 1    |
| 6   | G    | 22  | W    | 38  | m    | 54  | 2    |
| 7   | H    | 23  | X    | 39  | n    | 55  | 3    |
| 8   | I    | 24  | Y    | 40  | o    | 56  | 4    |
| 9   | J    | 25  | Z    | 41  | p    | 57  | 5    |
| 10  | K    | 26  | a    | 42  | q    | 58  | 6    |
| 11  | L    | 27  | b    | 43  | r    | 59  | 7    |
| 12  | M    | 28  | c    | 44  | s    | 60  | 8    |
| 13  | N    | 29  | d    | 45  | t    | 61  | 9    |
| 14  | O    | 30  | e    | 46  | u    | 62  | +    |
| 15  | P    | 31  | f    | 47  | v    | 63  | /    |

## パディング

エンコード対象のデータの長さが 3 バイトの倍数でない場合、データの末尾が 24 ビットのブロックに満たないことがあります。その場合、不足分を 0 ビットで埋め、エンコード後の文字列の末尾にパディング文字 `=` を付加します。

- 元データが 1 バイト余る場合 (8 ビット): エンコード後の末尾に `==` が付加されます。
- 元データが 2 バイト余る場合 (16 ビット): エンコード後の末尾に `=` が付加されます。

これにより、エンコード後の文字列の長さは常に 4 の倍数になります。

## URL セーフな Base64 (base64url)

標準の Base64 アルファベットに含まれる `+` と `/` は、URL やファイル名において特別な意味を持つ文字であるため、そのまま使用すると問題を引き起こす可能性があります。

この問題を解決するため、`+` を `-` (ハイフン) に、`/` を `_` (アンダースコア) に置き換えた「URL セーフ」な Base64 エンコーディング (base64url) が定義されています。パディングの `=` は URL エンコードされることがありますが、データ長が既知の場合は省略されることもあります。

## 利用例

- **Data URI scheme:** 画像などのリソースを HTML や CSS に直接埋め込む際に使用されます。
  `data:image/png;base64,iVBORw0KGgo...`
- **電子メール:** 画像ファイルなどを MIME の一部としてメール本文に埋め込む際に使用されます。
- **Basic 認証:** ユーザー名とパスワードをコロンで連結し、Base64 でエンコードして送信します。
- **JSON Web Token (JWT):** ヘッダーとペイロードを base64url でエンコードして使用します。

## 参考文献

- [RFC 4648: The Base16, Base32, and Base64 Data Encodings](https://datatracker.ietf.org/doc/html/rfc4648)
